<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mortgage Payoff Calculator (Version A)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    .mpc-container {
      max-width: 800px;
      margin: 0 auto;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 1.5rem;
      border-radius: 12px;
      border: 1px solid #ddd;
      background: #fafafa;
    }
    .mpc-container h2 {
      margin-top: 0;
      margin-bottom: 0.5rem;
    }
    .mpc-description {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 1rem;
    }
    .mpc-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 0.75rem 1rem;
    }
    .mpc-field {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
      font-size: 0.9rem;
    }
    .mpc-field label {
      font-weight: 600;
    }
    .mpc-field small {
      font-size: 0.8rem;
      color: #666;
    }
    .mpc-field input {
      padding: 0.45rem 0.55rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }
    .mpc-actions {
      margin-top: 1rem;
      display: flex;
      justify-content: flex-start;
      gap: 0.75rem;
    }
    .mpc-button {
      border-radius: 999px;
      border: none;
      padding: 0.55rem 1.25rem;
      font-size: 0.95rem;
      cursor: pointer;
      background: #1e88e5;
      color: #fff;
      font-weight: 600;
    }
    .mpc-button.secondary {
      background: #eee;
      color: #333;
      border: 1px solid #ccc;
    }
    .mpc-results {
      margin-top: 1rem;
      padding: 0.85rem 1rem;
      border-radius: 8px;
      background: #f4f8ff;
      border: 1px solid #c5d9ff;
      font-size: 0.9rem;
    }
    .mpc-results h4 {
      margin-top: 0;
      margin-bottom: 0.35rem;
    }
    .mpc-error {
      color: #b00020;
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }
    .mpc-disclaimer {
      margin-top: 1rem;
      font-size: 0.8rem;
      color: #777;
    }
    @media (max-width: 600px) {
      .mpc-container {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="mpc-container">
    <h2>Mortgage Payoff Calculator</h2>
    <p class="mpc-description">
      Start with your original loan details, estimate your remaining balance today, and see how an extra monthly
      principal payment could change your payoff date. This is for <strong>illustrative purposes only</strong> —
      actual figures may differ. Please confirm details with your lender.
    </p>

    <div id="mpc-mode-original">
      <h3 style="margin-top:0;">Start from Original Loan</h3>

      <div class="mpc-grid">
        <div class="mpc-field">
          <label for="mpc-orig-purchase-price">Original Purchase Price ($)</label>
          <input type="text" id="mpc-orig-purchase-price" placeholder="300000" />
          <small>If you know your original loan amount, enter it below.</small>
        </div>

        <div class="mpc-field">
          <label for="mpc-orig-loan-amount">Original Loan Amount ($)</label>
          <input type="text" id="mpc-orig-loan-amount" placeholder="Leave blank to use purchase price" />
          <small>Optional. Use this if you made a down payment.</small>
        </div>

        <div class="mpc-field">
          <label for="mpc-current-balance">Current Balance ($) – optional</label>
          <input type="text" id="mpc-current-balance" placeholder="e.g. 87000" />
          <small>If you know your current balance, enter it for more accurate payoff timing.</small>
        </div>

        <div class="mpc-field">
          <label for="mpc-orig-rate">Interest Rate (APR %)</label>
          <input type="text" id="mpc-orig-rate" placeholder="4.25" />
        </div>

        <div class="mpc-field">
          <label for="mpc-orig-term">Loan Term (years)</label>
          <input type="text" id="mpc-orig-term" value="30" />
          <small>Most fixed-rate mortgages are 15 or 30 years.</small>
        </div>

        <div class="mpc-field">
          <label for="mpc-orig-date">Purchase / Loan Start Date</label>
          <input type="date" id="mpc-orig-date" />
        </div>

        <div class="mpc-field">
          <label for="mpc-orig-extra">Extra Monthly Principal ($)</label>
          <input type="text" id="mpc-orig-extra" placeholder="e.g. 150" />
          <small>How much extra you'd like to add to principal each month.</small>
        </div>
      </div>

      <div class="mpc-actions">
        <button class="mpc-button" id="mpc-calc-btn" onclick="mpcCalculateOriginal()">Calculate</button>
        <button class="mpc-button secondary" id="mpc-reset-btn" onclick="mpcResetOriginal()">Reset</button>
      </div>

      <div id="mpc-orig-error" class="mpc-error"></div>
      <div id="mpc-orig-results" class="mpc-results" style="display:none;"></div>

      <!-- Email my results section -->
      <div id="mpc-email-section" style="display:none; margin-top:0.75rem; font-size:0.9rem;">
        <p><strong>Want these results emailed to you?</strong></p>
        <div style="display:flex; flex-wrap:wrap; gap:0.5rem; align-items:center;">
          <input
            type="email"
            id="mpc-user-email"
            placeholder="Your email address"
            style="flex:1; min-width:220px; padding:0.45rem 0.55rem; border-radius:6px; border:1px solid #ccc; font-size:0.9rem;"
          />
          <button class="mpc-button secondary" id="mpc-email-btn" type="button">
            Email My Results
          </button>
        </div>
        <div id="mpc-email-status" style="margin-top:0.25rem; font-size:0.8rem;"></div>
      </div>
    </div>

    <p class="mpc-disclaimer">
      This calculator estimates principal and interest based on a standard fixed-rate mortgage amortization.
      It does not account for escrow (taxes/insurance), adjustable rates, late payments, or fees.
      Always verify payoff amounts and dates with your loan servicer.
    </p>
  </div>

  <script>
    // ---------- Utility functions ----------
    function mpcFormatCurrency(value, decimals = 2) {
      const num = Number(value);
      if (!isFinite(num)) return '$0';
      return num.toLocaleString(undefined, {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    // Parse a number from an input by id: strip commas, trim, convert
    function mpcParseNumber(id) {
      const el = document.getElementById(id);
      if (!el) return NaN;
      const raw = (el.value || '').toString().replace(/,/g, '').trim();
      if (!raw) return NaN;
      const num = Number(raw);
      return isNaN(num) ? NaN : num;
    }

    function mpcDiffInMonths(d1, d2) {
      return (d2.getFullYear() - d1.getFullYear()) * 12 + (d2.getMonth() - d1.getMonth());
    }

    function mpcAddMonths(date, months) {
      const d = new Date(date.getTime());
      d.setMonth(d.getMonth() + months);
      return d;
    }

    function mpcFormatDate(date) {
      return date.toLocaleDateString(undefined, {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });
    }

    function mpcMonthlyPayment(P, annualRate, years) {
      const n = years * 12;
      if (n <= 0) return 0;
      if (annualRate === 0) return P / n;

      const r = annualRate / 12;
      const factor = Math.pow(1 + r, n);
      return P * (r * factor) / (factor - 1);
    }

    function mpcBalanceAfter(P, annualRate, years, kPayments) {
      const n = years * 12;
      const k = Math.max(0, Math.min(kPayments, n));

      if (annualRate === 0) {
        const principalPaid = (P / n) * k;
        return Math.max(0, P - principalPaid);
      }
      const r = annualRate / 12;
      const factorN = Math.pow(1 + r, n);
      const factorK = Math.pow(1 + r, k);
      const balance = P * (factorN - factorK) / (factorN - 1);
      return Math.max(0, balance);
    }

    function mpcMonthsToPayoff(balance, annualRate, monthlyPayment) {
      const B = balance;
      const Pmt = monthlyPayment;
      if (B <= 0 || Pmt <= 0) return 0;

      if (annualRate === 0) {
        return B / Pmt;
      }

      const r = annualRate / 12;
      if (Pmt <= B * r) {
        return Infinity;
      }

      const numerator = Math.log(Pmt / (Pmt - B * r));
      const denominator = Math.log(1 + r);
      return numerator / denominator;
    }

    // ---------- Reset ----------
    function mpcResetOriginal() {
      [
        'mpc-orig-purchase-price',
        'mpc-orig-loan-amount',
        'mpc-current-balance',
        'mpc-orig-rate',
        'mpc-orig-term',
        'mpc-orig-date',
        'mpc-orig-extra',
        'mpc-user-email'
      ].forEach(id => {
        const el = document.getElementById(id);
        if (!el) return;
        if (el.type === 'date') el.value = '';
        else el.value = '';
      });
      document.getElementById('mpc-orig-term').value = '30';
      document.getElementById('mpc-orig-error').textContent = '';
      document.getElementById('mpc-orig-results').style.display = 'none';
      document.getElementById('mpc-email-section').style.display = 'none';
      document.getElementById('mpc-email-status').textContent = '';
    }

    // ---------- Calculate ----------
    function mpcCalculateOriginal() {
      const errEl = document.getElementById('mpc-orig-error');
      const resEl = document.getElementById('mpc-orig-results');
      errEl.textContent = '';
      resEl.style.display = 'none';
      resEl.innerHTML = '';

      const purchasePrice = mpcParseNumber('mpc-orig-purchase-price');
      const loanAmountInput = mpcParseNumber('mpc-orig-loan-amount');
      const currentBalanceInput = mpcParseNumber('mpc-current-balance');
      const ratePct = mpcParseNumber('mpc-orig-rate');
      const termYears = mpcParseNumber('mpc-orig-term');
      const dateEl = document.getElementById('mpc-orig-date');
      const dateStr = dateEl && dateEl.value ? dateEl.value : '';
      const extra = mpcParseNumber('mpc-orig-extra');
      const extraSafe = isNaN(extra) ? 0 : extra;

      // Basic validation with friendly messages
      if (isNaN(purchasePrice) && isNaN(loanAmountInput)) {
        errEl.textContent = 'Please enter at least the original purchase price or original loan amount (numbers only, commas are okay).';
        return;
      }
      if (isNaN(ratePct) || ratePct <= 0) {
        errEl.textContent = 'Please enter a valid interest rate (numbers only, e.g. 3.65).';
        return;
      }
      if (isNaN(termYears) || termYears <= 0) {
        errEl.textContent = 'Please enter a valid loan term in years (numbers only).';
        return;
      }
      if (!dateStr) {
        errEl.textContent = 'Please enter your purchase / loan start date.';
        return;
      }

      const P = !isNaN(loanAmountInput) && loanAmountInput > 0 ? loanAmountInput : purchasePrice;
      const annualRate = ratePct / 100;
      const nTotal = termYears * 12;

      const startDate = new Date(dateStr + 'T00:00:00');
      const today = new Date();
      let monthsElapsed = mpcDiffInMonths(startDate, today);
      if (monthsElapsed < 0) monthsElapsed = 0;
      if (monthsElapsed > nTotal) monthsElapsed = nTotal;

      const monthlyPmt = mpcMonthlyPayment(P, annualRate, termYears);
      const remainingBalanceSchedule = mpcBalanceAfter(P, annualRate, termYears, monthsElapsed);

      const balanceForTimeline = !isNaN(currentBalanceInput) && currentBalanceInput > 0
        ? currentBalanceInput
        : remainingBalanceSchedule;

      let baselineMonthsRemaining = mpcMonthsToPayoff(balanceForTimeline, annualRate, monthlyPmt);
      if (!isFinite(baselineMonthsRemaining)) {
        errEl.textContent = 'Based on these inputs, the regular payment is too low to pay off the loan.';
        return;
      }
      const baselineMonthsRounded = Math.round(baselineMonthsRemaining);
      const baselinePayoffDateFromToday = mpcAddMonths(today, baselineMonthsRounded);

      const originalScheduledPayoffDate = mpcAddMonths(startDate, nTotal);

      let html = '<h4>Results</h4>';
      html += `<p><strong>Original loan amount:</strong> ${mpcFormatCurrency(P, 0)}</p>`;
      html += `<p><strong>Monthly principal &amp; interest (P&amp;I):</strong> ${mpcFormatCurrency(monthlyPmt)}</p>`;
      html += `<p><strong>Estimated remaining balance today (based on schedule):</strong> ${mpcFormatCurrency(remainingBalanceSchedule, 0)}</p>`;

      if (!isNaN(currentBalanceInput) && currentBalanceInput > 0) {
        html += `<p><strong>Balance you entered:</strong> ${mpcFormatCurrency(currentBalanceInput, 0)} (used for payoff estimates below)</p>`;
      }

      html += `<p><strong>Scheduled payoff date (based on full term):</strong> ${mpcFormatDate(originalScheduledPayoffDate)}</p>`;
      html += `<p><strong>Estimated payoff date from today (no extra):</strong> ${mpcFormatDate(baselinePayoffDateFromToday)}</p>`;

      if (extraSafe > 0) {
        const newMonthlyPmt = monthlyPmt + extraSafe;
        let newMonthsRem = mpcMonthsToPayoff(balanceForTimeline, annualRate, newMonthlyPmt);
        if (!isFinite(newMonthsRem)) {
          html += `<p style="color:#b00020;"><strong>Note:</strong> The extra payment entered is not enough to change the payoff date based on these numbers.</p>`;
        } else {
          const newMonthsRounded = Math.round(newMonthsRem);
          const newPayoffDate = mpcAddMonths(today, newMonthsRounded);
          const monthsSaved = Math.max(0, baselineMonthsRounded - newMonthsRounded);
          const yearsSaved = monthsSaved / 12;

          html += `<p><strong>New payoff date with extra ${mpcFormatCurrency(extraSafe)} / month:</strong> ${mpcFormatDate(newPayoffDate)}</p>`;
          if (monthsSaved > 0) {
            html += `<p>You would pay off the mortgage approximately <strong>${monthsSaved}</strong> months sooner (~<strong>${yearsSaved.toFixed(1)}</strong> years) by making this extra payment.</p>`;
          }
        }
      } else {
        html += `<p><em>Add an extra monthly principal amount above to see how much sooner you might pay off the loan.</em></p>`;
      }

      resEl.innerHTML = html;
      resEl.style.display = 'block';

      // Show email capture
      const emailSection = document.getElementById('mpc-email-section');
      if (emailSection) {
        emailSection.style.display = 'block';
      }
    }

    // ---------- Email via Zapier ----------
    // Replace this with your actual Zapier Webhooks "Catch Hook" URL
    const MPC_WEBHOOK_URL = "https://hooks.zapier.com/hooks/catch/XXXXXX/YYYYYY";

    async function mpcSendEmailResults() {
      const emailInput = document.getElementById('mpc-user-email');
      const statusEl = document.getElementById('mpc-email-status');
      const email = (emailInput.value || '').trim();

      statusEl.textContent = '';

      if (!email) {
        statusEl.textContent = 'Please enter your email address.';
        statusEl.style.color = '#b00020';
        return;
      }

      const purchasePrice = mpcParseNumber('mpc-orig-purchase-price');
      const loanAmountInput = mpcParseNumber('mpc-orig-loan-amount');
      const currentBalanceInput = mpcParseNumber('mpc-current-balance');
      const ratePct = mpcParseNumber('mpc-orig-rate');
      const termYears = mpcParseNumber('mpc-orig-term');
      const dateEl = document.getElementById('mpc-orig-date');
      const dateStr = dateEl && dateEl.value ? dateEl.value : '';
      const extra = mpcParseNumber('mpc-orig-extra');

      try {
        statusEl.textContent = 'Sending...';
        statusEl.style.color = '#555';

        await fetch(MPC_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            purchasePrice,
            originalLoanAmount: loanAmountInput,
            currentBalance: currentBalanceInput,
            ratePct,
            termYears,
            startDate: dateStr,
            extraMonthlyPrincipal: extra,
            source: 'Mortgage Payoff Calculator',
            timestamp: new Date().toISOString()
          })
        });

        statusEl.textContent = 'Got it! I’ll email these results to you.';
        statusEl.style.color = '#0a7c2f';
        emailInput.value = '';
      } catch (e) {
        statusEl.textContent = 'There was an issue sending your results. Please try again.';
        statusEl.style.color = '#b00020';
      }
    }

    // ---------- Wire up buttons ----------
    document.addEventListener('DOMContentLoaded', function () {
      const emailBtn = document.getElementById('mpc-email-btn');
      if (emailBtn) emailBtn.addEventListener('click', mpcSendEmailResults);
    });
  </script>
</body>
</html>
